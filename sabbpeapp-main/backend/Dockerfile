# Stage 1: Builder - Installs dependencies and compiles TypeScript
FROM node:20-alpine AS builder

WORKDIR /app

# Copy and install package dependencies
COPY package*.json ./
RUN npm install

# Copy application source code (including TypeScript files)
COPY . .

# CRITICAL: Compile the TypeScript code into distributable JavaScript
# This runs "tsc" based on your package.json script
RUN npm run build 

# Stage 2: Production - Runs the compiled application
FROM node:20-slim

WORKDIR /app

# Copy dependencies and the *compiled* app code from the builder stage
# The 'dist' folder is generated by 'npm run build'
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/dist ./dist 

# Set environment variables (Cloud Run expects 8080 by default)
EXPOSE 8080 

# Command to start the compiled application
# Your package.json points "main": "dist/index.js", so we use that.
CMD ["node", "dist/index.js"]